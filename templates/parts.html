{% extends "base.html" %}

{% block title %}Поиск запчасти{% endblock %}

{% block head %}
<style>
    .search-header {
        background: linear-gradient(135deg, #16a34a 0%, #0d9488 100%);
    }
    
    .part-card {
        transition: all 0.3s ease;
        border-radius: 12px;
        overflow: hidden;
    }
    
    .part-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
    }
    
    .original-badge {
        background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
    }
    
    .analog-badge {
        background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
    }
    
    .image-scroll {
        scrollbar-width: thin;
        scrollbar-color: #d1fae5 transparent;
    }
    
    .image-scroll::-webkit-scrollbar {
        height: 6px;
    }
    
    .image-scroll::-webkit-scrollbar-thumb {
        background-color: #d1fae5;
        border-radius: 3px;
    }
    
    .delivery-icon {
        width: 24px;
        height: 24px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }
    
    .delivery-air {
        background-color: #93c5fd;
        color: #1e40af;
    }
    
    .delivery-car {
        background-color: #86efac;
        color: #166534;
    }
    
    .delivery-sea {
        background-color: #bfdbfe;
        color: #1e3a8a;
    }
    
    .price-tooltip:hover .price-tooltip-text {
        visibility: visible;
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Header -->
<section class="search-header text-white rounded-2xl p-8 shadow-lg mb-8">
    <div class="max-w-4xl mx-auto text-center">
        <h1 class="text-3xl md:text-4xl font-extrabold leading-tight mb-2">
            Пошук запчастини по коду
        </h1>
        <p class="text-lg opacity-90">
            Знайдіть потрібну деталь за кодом виробника
        </p>
    </div>
</section>

<!-- Search Form -->
<div class="bg-white rounded-xl shadow-md p-6 mb-8">
    <form method="post" class="flex flex-col md:flex-row gap-4">
        <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-1">Код запчастини</label>
            <input
                type="text"
                name="code"
                placeholder="Наприклад: 12345-67890"
                value="{{ code or '' }}"
                required
                class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
            >
        </div>
        
        <div class="flex-1 hidden" id="brand-select-container">
            <label class="block text-sm font-medium text-gray-700 mb-1">Бренд</label>
            <select
                name="brandId"
                id="brand-select"
                class="w-full border h-14 border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition"
            >
                <option value="">Усі бренди</option>
            </select>
        </div>
        
        <div class="flex items-end">
            <button
                type="submit"
                class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold px-6 py-3 rounded-lg transition transform hover:scale-[1.02] shadow-md"
            >
                <span class="flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                    Знайти
                </span>
            </button>
        </div>
    </form>
</div>

{% if parts %}
    <div class="mb-6 flex justify-between items-center">
        <h2 class="text-2xl font-bold text-gray-800">
            Результати пошуку
        </h2>
        <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">
            {{ parts|length }} знайдено
        </span>
    </div>

    <div class="space-y-6">
        {% for part in parts|sort(attribute='isOriginal', reverse=True) %}
            <div class="part-card bg-white rounded-xl shadow-md overflow-hidden">
                <!-- Card Header -->
                <div class="p-6 pb-0">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">
                                {{ part.brand }} <span class="text-green-600">{{ part.code }}</span>
                            </h3>
                            <p class="text-gray-600 mt-1">{{ part.descriptionRus or 'Опис відсутній' }}</p>
                        </div>
                        
                        <span class="{% if part.isOriginal %}original-badge{% else %}analog-badge{% endif %} text-white text-xs font-bold px-3 py-1 rounded-full">
                            {{ 'Оригінал' if part.isOriginal else 'Аналог' }}
                        </span>
                    </div>
                    
                    <div class="mt-4 flex flex-wrap gap-2">
                        <span class="bg-gray-100 text-gray-800 text-xs px-3 py-1 rounded-full">
                            ID: {{ part.productId }}
                        </span>
                        {% if part.weight %}
                        <span class="bg-gray-100 text-gray-800 text-xs px-3 py-1 rounded-full">
                            Вага: {{ part.weight }}
                        </span>
                        {% endif %}
                    </div>
                </div>

                <!-- Properties -->
                {% if part.properties %}
                <div class="px-6 pt-4">
                    <h4 class="font-semibold text-gray-700 mb-2">Характеристики:</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                        {% for prop in part.properties %}
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-sm font-medium text-gray-500">{{ prop.name }}</p>
                            <p class="text-gray-800">{{ prop.value }}</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Images -->
                {% if part.images %}
                <div class="px-6 pt-6">
                    <h4 class="font-semibold text-gray-700 mb-3">Зображення:</h4>
                    <div class="image-scroll flex gap-4 pb-2 overflow-x-auto">
                        {% for img in part.images %}
                        <img src="{{ img.image }}" alt="Зображення запчастини" class="h-40 rounded-lg border object-contain">
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Analogs -->
                {% if part.analogs %}
                <div class="px-6 pt-6">
                    <div class="border-t border-gray-200 pt-4">
                        <button type="button"
                                class="text-green-600 hover:text-green-800 font-medium flex items-center gap-1"
                                onclick="this.nextElementSibling.classList.toggle('hidden')">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                            Аналоги ({{ part.analogs|length }})
                        </button>
                        <div class="mt-2 hidden">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <ul class="space-y-2">
                                    {% for analog in part.analogs %}
                                    <li class="text-sm">
                                        <span class="font-medium">{{ analog.brand }}</span> - 
                                        <span class="text-green-600">{{ analog.code }}</span>
                                        {% if analog.descriptionRus %}
                                        <span class="text-gray-500">({{ analog.descriptionRus }})</span>
                                        {% endif %}
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Rests -->
                <div class="px-6 pt-6 pb-6">
                    <h4 class="font-semibold text-gray-700 mb-3">Наявність:</h4>
                    {% if part.rests and part.rests|length > 0 %}
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Постачальник</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ціна</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Кількість</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Доставка</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Повернення</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for rest in part.rests %}
                                <tr class="hover:bg-gray-50 {% if loop.index > 5 %}hidden extra-row{% endif %}">
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="text-sm font-medium text-gray-900">{{ rest.priceLogo }}</div>
                                            <div class="ml-1 text-yellow-500">★{{ rest.priceQuality }}</div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <div class="relative inline-block">
                                          <span class="text-sm font-medium text-gray-900">
                                            {{ rest.price }} {{ rest.currency }}
                                          </span>
                                          {% if not rest.is_price_final %}
                                          <span class="relative group">
                                                <span class="text-yellow-600 cursor-help">*</span>
                                                <span class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-1 hidden group-hover:block bg-gray-800 text-white text-xs rounded px-2 py-1 whitespace-nowrap">
                                                +Послуги доставки
                                                </span>
                                          </span>
                                            {% endif %}
                                        </div>
                                      </td>
                                      
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">{{ rest.quantity }}</td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <div class="flex items-center gap-2">
                                            <span class="delivery-icon {% if rest.deliveryType == 'Авиа' %}delivery-air{% elif rest.deliveryType == 'Авто' %}delivery-car{% else %}delivery-sea{% endif %}">
                                                {% if rest.deliveryType == 'Авиа' %}✈️
                                                {% elif rest.deliveryType == 'Авто' %}🚚
                                                {% else %}🚢{% endif %}
                                            </span>
                                            <span class="text-sm">{{ rest.deliveryTime }} дн.</span>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        {% if rest.isReturn %}
                                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Так</span>
                                        {% else %}
                                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Ні</span>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                                        <button type="button"
                                                class="text-green-600 hover:text-green-900"
                                                onclick="showAddToCartModal(this)"
                                                data-code="{{ part.code }}"
                                                data-brand="{{ part.brand }}"
                                                data-price="{{ rest.price }}"
                                                data-currency="{{ rest.currency }}"
                                                data-price-logo="{{ rest.priceLogo }}"
                                                data-price-quality="{{ rest.priceQuality }}"
                                                data-is-price-final="{{ rest.isPriceFinal }}"
                                                data-is-return="{{ rest.isReturn }}"
                                                data-delivery-type="{{ rest.deliveryType }}"
                                                data-delivery-time="{{ rest.deliveryTime }}">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                                            </svg>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% if part.rests|length > 5 %}
                        <div class="mt-4 text-center">
                            <button type="button"
                                    onclick="toggleExtraRows(this)"
                                    class="text-sm text-green-600 hover:text-green-800 font-medium flex items-center justify-center gap-1 mx-auto">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                                Показати всіх {{ part.rests|length }} постачальників
                            </button>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="bg-gray-50 rounded-lg p-4 text-center">
                        <p class="text-gray-500">Немає даних про наявність</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>
{% elif searched %}
    <div class="bg-white rounded-xl shadow-md p-8 text-center">
        <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </div>
        <h3 class="mt-3 text-lg font-medium text-gray-900">Нічого не знайдено</h3>
        <p class="mt-2 text-gray-500">Перевірте правильність коду запчастини та спробуйте ще раз.</p>
        <div class="mt-6">
            <button type="button" onclick="window.location.reload()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none">
                Спробувати знову
            </button>
        </div>
    </div>
{% endif %}

<!-- Add to Cart Modal -->
<div id="addToCartModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md relative transform transition-all">
        <button onclick="closeAddToCartModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>

        <div class="text-center">
            <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-green-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
            </div>
            <h2 class="mt-3 text-xl font-bold text-gray-900">Додати до кошика</h2>
        </div>

        <form method="POST" action="{{ url_for('add_to_cart') }}" id="addToCartForm" class="mt-6 space-y-4">
            <input type="hidden" name="code">
            <input type="hidden" name="brand">
            <input type="hidden" name="price">
            <input type="hidden" name="currency">
            <input type="hidden" name="priceLogo">
            <input type="hidden" name="priceQuality">
            <input type="hidden" name="isPriceFinal">
            <input type="hidden" name="isReturn">
            <input type="hidden" name="deliveryType">
            <input type="hidden" name="deliveryTime">

            <div id="modalInfo" class="text-sm text-gray-700 space-y-2"></div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Кількість</label>
                <input type="number" name="quantity" value="1" min="1" max="99" 
                    class="w-24 border border-gray-300 rounded-lg px-3 py-2 focus:ring-green-500 focus:border-green-500">
            </div>

            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out transform hover:scale-[1.02]">
                Підтвердити
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const codeInput = document.querySelector('input[name="code"]');
        const brandSelectContainer = document.getElementById('brand-select-container');
        const brandSelect = document.getElementById('brand-select');
    
        codeInput.addEventListener("input", async function () {
            const code = this.value.trim();
    
            if (code.length < 2) {
                brandSelectContainer.classList.add('hidden');
                brandSelect.innerHTML = `<option value="">Усі бренди</option>`;
                return;
            }
    
            try {
                const res = await fetch("/get_brands", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ code })
                });
    
                const data = await res.json();
    
                if (data.success && data.brands.length > 0) {
                    brandSelect.innerHTML = `<option value="">Усі бренди</option>`;
                    data.brands.forEach(brand => {
                        brandSelect.innerHTML += `<option value="${brand.brandId}">${brand.brand}</option>`;
                    });
                    brandSelectContainer.classList.remove('hidden');
                } else {
                    brandSelect.innerHTML = `<option value="">Усі бренди</option>`;
                    brandSelectContainer.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error fetching brands:', error);
            }
        });
    });

    function toggleExtraRows(button) {
        const container = button.closest('div').previousElementSibling;
        const rows = container.querySelectorAll('.extra-row');
        const isHidden = rows[0].classList.contains('hidden');

        rows.forEach(row => {
            row.classList.toggle('hidden');
        });

        button.innerHTML = isHidden ? 
            `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd" />
            </svg>
            Сховати` : 
            `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
            Показати всі`;
    }

    function showAddToCartModal(button) {
        const modal = document.getElementById("addToCartModal");
        const form = document.getElementById("addToCartForm");

        const fields = [
            'code',
            'brand',
            'price',
            'currency',
            'price-logo',
            'price-quality',
            'is-price-final',
            'is-return',
            'delivery-type',
            'delivery-time'
        ];

        fields.forEach(field => {
            const inputName = field.replace(/-([a-z])/g, (_, char) => char.toUpperCase());
            const value = button.getAttribute(`data-${field}`);
            form.elements[inputName].value = value;
        });

        const brand = button.getAttribute('data-brand');
        const code = button.getAttribute('data-code');
        const price = button.getAttribute('data-price');
        const currency = button.getAttribute('data-currency');
        const deliveryType = button.getAttribute('data-delivery-type');
        const deliveryTime = button.getAttribute('data-delivery-time');
        const isFinal = button.getAttribute('data-is-price-final') === 'true';
        const priceLogo = button.getAttribute('data-price-logo');
        const priceQuality = button.getAttribute('data-price-quality');

        document.getElementById("modalInfo").innerHTML = `
            <div class="text-center">
                <p class="font-bold text-lg">${brand} ${code}</p>
                <p class="text-gray-600">${priceLogo} ★${priceQuality}</p>
            </div>
            <div class="bg-gray-50 p-3 rounded-lg">
                <div class="flex justify-between">
                    <span class="font-medium">Ціна:</span>
                    <span class="font-bold text-green-600">${price} ${currency}</span>
                </div>
                <div class="flex justify-between mt-1">
                    <span class="font-medium">Доставка:</span>
                    <span>${deliveryType} (${deliveryTime} дн.)</span>
                </div>
            </div>
            ${!isFinal ? '<p class="text-yellow-600 text-sm mt-2">* Ціна не включає вартість доставки</p>' : ''}
        `;

        modal.classList.remove("hidden");
    }

    function closeAddToCartModal() {
        document.getElementById("addToCartModal").classList.add("hidden");
    }
</script>
{% endblock %}